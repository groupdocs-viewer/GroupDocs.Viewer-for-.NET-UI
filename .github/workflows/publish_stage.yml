name: Publish Stage

on:
  workflow_dispatch:

jobs:
  publish_stage:
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: true
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          global-json-file: global.json

      - name: Build packages
        env:
          BUILD_TYPE: STAGE
        run: .\build.ps1

      - name: Download CodeSignTool
        run: |
          Invoke-WebRequest -Uri https://github.com/SSLcom/CodeSignTool/releases/download/v1.3.0/CodeSignTool-v1.3.0-windows.zip -OutFile codesign.zip
      
      - name: Unpack CodeSignTool
        run: |
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\code_sign" | Out-Null
          Expand-Archive -Path codesign.zip -DestinationPath "$env:GITHUB_WORKSPACE\code_sign" -Force

      - name: Sign packages with SSL.com eSigner (manual)
        working-directory: ${{ github.workspace }}\code_sign
        run: |
          & ".\jdk-11.0.2\bin\java" -jar ".\jar\code_sign_tool-1.3.0.jar" batch_sign -username="${{ secrets.ES_USERNAME }}" -password="${{ secrets.ES_PASSWORD }}" -totp_secret="${{ secrets.ES_TOTP_SECRET }}" -input_dir_path="$env:GITHUB_WORKSPACE/build_out" -output_dir_path="$env:GITHUB_WORKSPACE/artifacts"

      - name: Verify signatures
        run: dotnet nuget verify .\artifacts\*.nupkg --all

      - name: Publish to Stage
        env:
          NUGET_API_KEY_STAGE: ${{ secrets.NUGET_API_KEY_STAGE }}
        run: .\publish-stage.ps1

      - name: Archive packages
        uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: artifacts